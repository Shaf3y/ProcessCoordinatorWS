package com.marisoft.ziba.cep.jms;

import java.io.File;
import java.net.URISyntaxException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.jms.core.JmsTemplate;

import com.espertech.esper.adapter.AdapterSPI;
import com.espertech.esper.client.Configuration;
import com.espertech.esper.client.EPAdministrator;
import com.espertech.esper.client.EPRuntime;
import com.espertech.esper.client.EPServiceProvider;
import com.espertech.esper.client.EPServiceProviderManager;
import com.espertech.esper.client.EPStatement;
import com.espertech.esperio.jms.SpringJMSTemplateInputAdapter;

public class EsperEventProcessingAgent {
	
	@Autowired
	private SpringJMSTemplateInputAdapter inputAdapter;

	@Autowired
	private JmsTemplate jmsTemplate;
	
	private String configFile;
	
	public void setConfigFile(String configFile) {
		this.configFile = configFile;
	}
		
	public void start() throws URISyntaxException {
//		File file = new File(this.getClass().getClassLoader().getResource(configFile).toURI());
		
		Configuration configuration = new Configuration();
//		configuration.configure(file);		
		
		configuration.addEventType("MyInputEvent", MyInputEvent.class);
		
		EPServiceProvider cepService = EPServiceProviderManager.getProvider("BusinessProcessEvents", configuration);
		
		if(inputAdapter instanceof AdapterSPI) {
			
		}
		
		EPRuntime cepServiceRT = cepService.getEPRuntime();
		EPAdministrator cepAdmin = cepService.getEPAdministrator();
				
		EPStatement stmt = cepAdmin.createEPL("select * from MyInputEvent");
				
		stmt.addListener(new MyInputEventListener(jmsTemplate));
		
		System.out.println("Loaded Successfully");
	}

}
