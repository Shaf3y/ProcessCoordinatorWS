package com.marisoft.ziba.cep.jms;

import java.io.File;
import java.io.IOException;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.ApplicationContext;
import org.springframework.context.support.ClassPathXmlApplicationContext;
import org.springframework.jms.core.JmsTemplate;
import org.springframework.stereotype.Component;

import com.espertech.esper.client.Configuration;
import com.espertech.esper.client.EPAdministrator;
import com.espertech.esper.client.EPRuntime;
import com.espertech.esper.client.EPServiceProvider;
import com.espertech.esper.client.EPServiceProviderManager;
import com.espertech.esper.client.EPStatement;

@Component
public class EsperEventProcessingAgent {

	@Autowired
	private JmsTemplate jmsTemplate;
	
	
	
	public void start() {
		File file = applicationContext.getResource("META-INF/esper.cfg.xml").getFile();
		
		Configuration configuration = new Configuration();
		configuration.configure(file);
		
		EPServiceProvider cepService = EPServiceProviderManager.getProvider("BusinessProcessEvents", configuration);
		EPRuntime cepServiceRT = cepService.getEPRuntime();
		EPAdministrator cepAdmin = cepService.getEPAdministrator();
		
		EPStatement stmt = cepAdmin.createEPL("select * from MyInputEvent");
		
		
		stmt.addListener(new MyInputEventListener(jmsTemplate));
		
		System.out.println("Loaded Successfully");
	}

}
